{% load static %}
<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <!-- Viewport essencial para responsividade -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazer Pedido</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen pb-24 lg:pb-0">

    {% include "nav.html" %}

    <main class="container mx-auto px-4 py-6 mt-16 lg:mt-20">

        <!-- Header do Usuário -->
        <!-- Flex-col no mobile para empilhar, sm:flex-row para alinhar lado a lado em telas maiores -->
        <div class="bg-white p-5 rounded-lg shadow mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center border-l-4 border-green-600 gap-4">
            <div class="w-full sm:w-auto">
                <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Bem-vindo(a)</p>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 break-words">{{ request.user.full_name }}</h2>
                <p class="text-sm text-gray-600 font-medium">{{ request.user.matricula }}</p>
            </div>
            <div class="h-12 w-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-xl shadow-sm self-end sm:self-center">
                <i class="fa-solid fa-user"></i>
            </div>
        </div>

        <!-- Mensagens de Feedback -->
        {% if messages %}
        <div class="mb-6 space-y-3">
            {% for message in messages %}
            <div class="p-4 rounded-lg shadow border-l-4 
                {% if message.tags == 'success' %} bg-green-50 border-green-600 text-green-800
                {% elif message.tags == 'error' %} bg-red-50 border-red-600 text-red-800
                {% elif message.tags == 'warning' %} bg-yellow-50 border-yellow-500 text-yellow-800
                {% else %} bg-blue-50 border-blue-600 text-blue-800 {% endif %}
                flex items-center justify-between transition-all duration-300">

                <div class="flex items-center gap-3">
                    {% if message.tags == 'success' %} <i class="fa-solid fa-circle-check"></i>
                    {% elif message.tags == 'error' %} <i class="fa-solid fa-circle-xmark"></i>
                    {% elif message.tags == 'warning' %} <i class="fa-solid fa-triangle-exclamation"></i>
                    {% else %} <i class="fa-solid fa-circle-info"></i> {% endif %}
                    <span class="font-medium text-sm sm:text-base">{{ message }}</span>
                </div>

                <button onclick="this.parentElement.remove()" class="text-sm opacity-60 hover:opacity-100 p-2">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}


        <!-- Layout Principal: Flex Column no mobile, Row no Desktop -->
        <div class="flex flex-col lg:flex-row gap-8 relative">

            <!-- COLUNA DE ITENS -->
            <div class="w-full lg:w-2/3">
                <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-box-open text-green-600"></i> Itens Disponíveis
                </h2>

                <!-- Grid Responsivo: 1 col (mobile), 2 cols (tablet), 3 cols (desktop grande) -->
                <div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6">
                    {% for item in items %}
                    {% if item.quantity_available > 0 %}
                    <div class="bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col justify-between h-full border border-gray-100" data-item-name="{{ item.name|lower }}">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-1 leading-tight">{{ item.name }}</h3>
                            <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">
                                    {{ item.quantity_available }} un
                                </span>
                                <span>em estoque</span>
                            </div>
                        </div>
                        
                        <!-- Botão com feedback visual de toque (active:scale) -->
                        <button onclick="addToCart('{{ item.id }}', '{{ item.name }}', '{{ item.quantity_available }}')"
                            class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 active:scale-95 transition-all text-white py-3 rounded-md font-medium shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Adicionar
                        </button>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- COLUNA DO CARRINHO -->
            <!-- Adicionado ID para navegação do botão flutuante -->
            <div id="carrinho-area" class="w-full lg:w-1/3">
                <!-- Sticky apenas em telas grandes (lg) -->
                <div class="bg-white rounded-lg shadow-lg lg:sticky lg:top-24 border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <span class="font-bold text-gray-800 text-lg">Minha Solicitação</span>
                        <span id="cart-count-badge" class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full hidden">0</span>
                    </div>

                    <div id="cart-items" class="p-5 min-h-[150px] max-h-[400px] overflow-y-auto text-gray-400 text-center italic flex flex-col justify-center items-center">
                        <i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-20"></i>
                        <p>Seu carrinho está vazio.</p>
                    </div>

                    <div class="p-4 border-t bg-gray-50">
                        <form method="POST" action="{% url 'storage:request-order' %}" id="order-form">
                            {% csrf_token %}
                            <div id="cart-hidden-inputs"></div>

                            <button type="submit"
                                class="w-full bg-green-600 hover:bg-green-700 active:scale-95 transition-transform text-white py-3.5 rounded-md font-bold text-lg shadow-md flex justify-center items-center gap-2">
                                <span>Enviar Pedido</span>
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- BOTÃO FLUTUANTE APENAS PARA MOBILE -->
    <!-- Leva o usuário até a área do carrinho sem precisar rolar tudo -->
    <a href="#carrinho-area" id="mobile-cart-btn" class="fixed bottom-6 right-6 h-14 w-14 bg-green-600 text-white rounded-full shadow-2xl flex items-center justify-center text-xl z-50 lg:hidden transform transition-transform scale-0 duration-300">
        <i class="fa-solid fa-cart-shopping"></i>
        <span id="mobile-cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold h-6 w-6 flex items-center justify-center rounded-full border-2 border-white">0</span>
    </a>

    <!-- MODAL DE SUCESSO -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 px-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform transition-all scale-100">
            <div class="h-16 w-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-3xl mx-auto mb-4">
                <i class="fa-solid fa-check"></i>
            </div>
            <h3 class="text-2xl font-bold mb-2 text-gray-800">Pedido Realizado!</h3>
            <p class="text-gray-600 mb-6">Seu pedido foi enviado para o almoxarifado. Por favor, dirija-se ao balcão.</p>
            <button onclick="closeModal()" class="w-full bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                Fechar
            </button>
        </div>
    </div>

    <script>
        let cart = [];

        function addToCart(id, name, stock) {
            stock = parseInt(stock);
            const existing = cart.find(i => i.id === id);

            if (existing) {
                if (existing.quantity < stock) {
                    existing.quantity++;
                } else {
                    alert("Limite de estoque atingido para este item."); // Feedback simples
                    return;
                }
            } else {
                cart.push({ id, name, quantity: 1 });
            }
            renderCart();
            updateHiddenInputs();
            updateMobileFab(); // Atualiza o botão flutuante
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            renderCart();
            updateHiddenInputs();
            updateMobileFab();
        }

        function renderCart() {
            const el = document.getElementById('cart-items');
            const badge = document.getElementById('cart-count-badge');
            
            // Atualiza badge desktop
            const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);
            if(totalItems > 0) {
                badge.textContent = totalItems;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            if (!cart.length) {
                el.innerHTML = `
                    <i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-20"></i>
                    <p>Seu carrinho está vazio.</p>
                `;
                el.classList.add('justify-center', 'items-center', 'flex', 'flex-col');
                return;
            }

            // Remove classes de centralização quando tem itens
            el.classList.remove('justify-center', 'items-center', 'flex', 'flex-col');

            el.innerHTML = cart.map(item => `
            <div class="flex justify-between items-center mb-3 p-2 bg-gray-50 rounded border border-gray-100">
                <div class="flex flex-col">
                    <span class="font-bold text-gray-700 text-sm">${item.name}</span>
                    <span class="text-xs text-gray-500">Qtd: ${item.quantity}</span>
                </div>
                <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded-full transition-colors">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `).join('');
        }

        function updateHiddenInputs() {
            const container = document.getElementById("cart-hidden-inputs");
            container.innerHTML = '';

            cart.forEach(item => {
                container.innerHTML += `
                <input type="hidden" name="items[]" value="${item.id}:${item.quantity}">
            `;
            });
        }

        // Função nova para controlar o botão flutuante no mobile
        function updateMobileFab() {
            const fab = document.getElementById('mobile-cart-btn');
            const countBadge = document.getElementById('mobile-cart-count');
            const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);

            countBadge.innerText = totalItems;

            if (totalItems > 0) {
                fab.classList.remove('scale-0');
                fab.classList.add('scale-100');
            } else {
                fab.classList.remove('scale-100');
                fab.classList.add('scale-0');
            }
        }
        
        // Exemplo de func para fechar modal (caso use a lógica de abrir modal via JS no futuro)
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }
    </script>
</body>
</html>