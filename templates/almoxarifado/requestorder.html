{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Fazer Pedido</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

    {% include "nav.html" %}

    <main class="container mx-auto px-4 py-8 mt-20">

        <!-- Header -->
        <div class="bg-white p-4 rounded-lg shadow mb-8 flex justify-between items-center border-l-4 border-green-600">
            <div>
                <p class="text-xs text-gray-500 uppercase font-bold">Bem-vindo(a)</p>
                <h2 class="text-xl font-bold">{{ request.user.full_name }}</h2>
                <p class="text-sm text-gray-600">{{ request.user.matricula }}</p>
            </div>
            <div class="h-10 w-10 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                <i class="fa-solid fa-user"></i>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- ITENS -->
            <div class="lg:w-2/3">
                <h2 class="text-xl font-bold mb-4">Itens Disponíveis</h2>

                <div id="inventory-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    {% for item in items %}
                    {% if item.quantity_available > 0 %}
                    <div class="bg-white p-4 rounded shadow item-card" data-item-name="{{ item.name|lower }}">
                        <h3 class="font-bold">{{ item.name }}</h3>
                        <p class="text-sm text-gray-500">
                            Em estoque: {{ item.quantity_available }}
                        </p>
                        <button onclick="addToCart('{{ item.id }}', '{{ item.name }}', '{{ item.quantity_available }}')"
                            class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded">
                            <i class="fa-solid fa-plus mr-1"></i> Adicionar
                        </button>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- CARRINHO -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded shadow sticky top-24">
                    <div class="p-4 border-b font-bold">
                        Minha Solicitação
                    </div>

                    <div id="cart-items" class="p-4 min-h-[150px] text-gray-400 text-center italic">
                        Nenhum item selecionado.
                    </div>

                    <div class="p-4 border-t">
                        <button id="btn-submit" onclick="finalizeRequest()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded font-bold">
                            Enviar Pedido
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </main>



    <!-- MODAL -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded shadow text-center">
            <h3 class="text-xl font-bold mb-2">Pedido realizado!</h3>
            <p class="text-gray-600 mb-4">Dirija-se ao balcão.</p>
            <button onclick="closeModal()" class="bg-green-600 text-white px-4 py-2 rounded">
                Novo Pedido
            </button>
        </div>
    </div>

    <script>
        let cart = [];

        function addToCart(id, name, stock) {
            stock = parseInt(stock);
            const existing = cart.find(i => i.id === id);

            if (existing) {
                if (existing.quantity < stock) {
                    existing.quantity++;
                }
            } else {
                cart.push({ id, name, quantity: 1, maxStock: stock });
            }
            renderCart();
        }

        function removeFromCart(id) {
            cart = cart.filter(i => i.id !== id);
            renderCart();
        }

        function renderCart() {
            const el = document.getElementById('cart-items');

            if (!cart.length) {
                el.innerHTML = 'Nenhum item selecionado.';
                return;
            }

            el.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center mb-2">
                    <span>${item.name} (${item.quantity})</span>
                    <button onclick="removeFromCart('${item.id}')" class="text-red-500">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        async function finalizeRequest() {
            if (!cart.length) return;

            const response = await fetch("{% url 'request-order-api' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ items: cart })
            });

            if (response.ok) {
                document.getElementById('successModal').classList.remove('hidden');
                document.getElementById('successModal').classList.add('flex');
                cart = [];
                renderCart();
            }
        }

        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        function getCookie(name) {
            let cookieValue = null;
            document.cookie.split(';').forEach(c => {
                c = c.trim();
                if (c.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(c.split('=')[1]);
                }
            });
            return cookieValue;
        }
    </script>

</body>

</html>